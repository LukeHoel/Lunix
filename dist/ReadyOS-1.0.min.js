var echo=function(e,r){console.log(e,"color: "+r)},fileSystemChanged=function(){},mkdirOrTouch=function(e,r){fileSystem.pwd;var t=splitDirAndEndSeg(e);if(t.dir.isDirectory){if(t.dir){if(!t.dir.children[t.endSeg])return t.dir.children[t.endSeg]=newFile(t.dir,r),echo(path()+(r?" mkdir ":" touch ")+e),fileSystemChanged(),t.dir.children[t.endSeg];echo('Directory "'+e+'" already exists')}}else echo("File already exists, or is not a directory ")},cd=function(e){if(e){var r=dirAtPath(e,"isValid"),t=e.split("/");r?(fileSystem.pwd="/"==e.charAt(0)?fileSystem.root:fileSystem.pwd,t.forEach(function(e){e&&("."==e?fileSystem.pwd=fileSystem.pwd:".."==e&&fileSystem.pwd!=fileSystem.root?fileSystem.pwd=fileSystem.pwd.parentDir:fileSystem.pwd=fileSystem.pwd.children[e])}),echo(pwd())):echo("Directory not found")}else fileSystem.pwd=fileSystem.root},ls=function(e){var r=dirAtPath(e,"dir"),t=Object.keys(r.children),n="";t.forEach(function(e){n+=e+" "}),echo(n||path()+" ls "+(e||"/"))},rm=function(e){var r=splitDirAndEndSeg(e);r.dir.parentDir?(delete r.dir.parentDir.children[r.endSeg],fileSystemChanged()):echo(notFound)},rmByObj=function(e){var r=getMyKeyName(e);delete e.parentDir.children[r],fileSystemChanged()},mvOrcp=function(e,r,t){var n=dirAtPath(e),a=splitDirAndEndSeg(r);n?a.dir.children[a.endSeg]?echo(fileAlreadyExists):(a.dir.children[a.endSeg]=angular.copy(n),a.dir.children[a.endSeg].parentDir=a.dir,t||rmByObj(n),fileSystemChanged()):echo(notFound)},extraCommands=function(){echo('Unrecognized command "'+splitCommand[0]+'"')},compile=function(e,r){var t=JSON.stringify(processScript(dirAtPath(e,"dir").content));t&&(mkdirOrTouch(r,!1).content=t,fileSystemChanged(),echo(path()+" compile "+e,successColor))},getContent=function(e){echo(dirAtPath(e))},setContent=function(e,r){dirAtPath(e).content=r},notFound="Not Found",fileAlreadyExists="File with same name exists in this location",error=function(e){echo(e,errorColor)},paramsError=function(e){throw new Error("Wrong number of arguments in call to method "+e)},fileSystem={root:{children:{},isDirectory:!0},pwd:null};function newFile(e,r){return{parentDir:e,isDirectory:r,children:{},content:""}}function pwd(){for(var e="",r=fileSystem.pwd;r.parentDir;)e="/"+getMyKeyName(r)+e,r=r.parentDir;return e}function getMyKeyName(r){var t,n=r.parentDir;return Object.keys(n.children).forEach(function(e){t||n.children[e]==r&&(t=e)}),t}function dirAtPath(e,r){if(e){var t=e.split("/"),n=!0,a="/"==e.charAt(0)?fileSystem.root:fileSystem.pwd;return t.forEach(function(e){e&&n&&("."==e?a=a:".."==e?a=a.parentDir:a.children[e]?a=a.children[e]:n=!1)}),"isValid"==r?n&&a.isDirectory:a}return"isValid"==r||fileSystem.pwd}function splitDirAndEndSeg(e){var r=e.split("/"),t=r[r.length-1],n=e.lastIndexOf("/");return{dir:dirAtPath(0<n?e.substr(0,n):e,"dir"),endSeg:t}}function copy(e){return JSON.parse(JSON.stringify(e))}path=function(){return"["+pwd()+"]"},Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{enumerable:!1,value:function(r){return 0<this.filter(function(e){return e==r}).length}});var parseProgramJson=function(e){var r=dirAtPath(e,"dir");if(r&&!r.isDir&&r.content)return JSON.parse(r.content);echo("File doesn't exist or is a directory")},execute=function(r){if(r.forEach(function(e){"main"==e.name&&(r.main=e)}),!r.main)throw new Error("Method with name 'main' and return type void not found");r.variables={},evaluateNode(r.main,r.main,r)},evaluateNode=function(node,method,program){var ret;return node.children&&node.children.forEach(function(child){switch(child.type){case"VARIABLE_ASSIGNMENT":setVariable(child,method,program,null);break;case"STRING":case"NUMBER":ret="NUMBER"==child.type?parseFloat(child.name):child.name;break;case"FUNCTION_CALL":var func=getFunctionObject(child,method,program);switch(func.type){case"scan":case"arrayDef":case"arrayValue":case"andor":case"command":ret=func.content;break;default:if(func.parameters){func.parameters.length!=child.children.length&&paramsError(child.name);for(var i=0;i<func.parameters.length;i++)setVariable({name:func.parameters[i],children:[child.children[i]]},func,program,method)}ret=evaluateNode(func,func,program)}break;case"VARIABLE_IDENTIFIER":ret=getVariableValue(child.name,method,program);break;case"ARITHMETIC":var lookUp={PLUS:"+",MINUS:"-",MULTIPLY:"*",DIVIDE:"/",MODULO:"%"},evaluatedFirst=evaluateNode({children:[child.children[0]]},method,program),evaluatedSecond=evaluateNode({children:[child.children[1]]},method,program);"string"==typeof evaluatedFirst&&(evaluatedFirst='"'+evaluatedFirst+'"'),"string"==typeof evaluatedSecond&&(evaluatedSecond='"'+evaluatedSecond+'"'),ret=eval(evaluatedFirst+lookUp[child.operator]+evaluatedSecond),ret!=ret&&(ret="NaN");break;case"COMPARATOR":var lookUp={EQUALEQUAL:"==",LESSER:"<",GREATER:">",NOTEQUAL:"!="},evaluatedFirst=evaluateNode({children:[child.children[0]]},method,program),evaluatedSecond=evaluateNode({children:[child.children[1]]},method,program);"string"==typeof evaluatedFirst&&(evaluatedFirst='"'+evaluatedFirst+'"'),"string"==typeof evaluatedSecond&&(evaluatedSecond='"'+evaluatedSecond+'"'),ret=eval(evaluatedFirst+lookUp[child.operator]+evaluatedSecond);break;case"RETURN":case"EXPRESSION":ret=evaluateNode(child,method,program);break;case"BLOCK":switch(child.blockType){case"IF":evaluateNode(child.statement,method,program)?evaluateNode(child,method,program):"else"in child&&evaluateNode(child.else,method,program);break;case"WHILE":for(;evaluateNode(child.statement,method,program);)evaluateNode(child,method,program)}}}),ret},setVariable=function(e,r,t,n){r.variables||(r.variables={});var a=evaluateNode(e,n||r,t);r.variables[e.name]=a},getFunctionObject=function(r,e,t){var n=reservedFunctions(r,e,t);if(!n&&(t.forEach(function(e){e.name==r.name&&(n=e)}),!n))throw new Error("Method with name "+r.name+" not found, or an error occured in evaluation");return n},getVariableValue=function(e,r,t){if(e in r.variables)return r.variables[e];throw new Error("Variable with name "+e+" not found")},reservedFunctions=function(e,r,t){var n;switch(e.name){case"print":((d=e.children.length)<1||2<d)&&paramsError(e.name),n=evaluateNode({children:[e.children[0]]},r,t)||" ";var a="";e.children[1]&&(a=evaluateNode({children:[e.children[1]]},r,t)),echo(n,a);break;case"scan":n={type:"scan",content:getUserInput(evaluateNode(e,r,t))},isNaN(n.content)||(n.content=parseInt(n.content));break;case"arrayDef":var o=[];e.children.forEach(function(e){o.push(evaluateNode({children:[e]},r,t))}),n={type:"arrayDef",content:o};break;case"arrayGet":case"arraySet":(d=e.children.length)!=("arrayGet"==e.name?2:3)&&paramsError(e.name);o=evaluateNode({children:[e.children[0]]},r,t);if(!Array.isArray(o))throw new Error("Wrong type of value in parameter 0 of valueAtIndex method. Must be array");var c=evaluateNode({children:[e.children[1]]},r,t);if(c<0||c>o.length)throw new Error("Array index out of range of array");"arraySet"==e.name&&(o[c]=evaluateNode({children:[e.children[2]]},r,t)),n={type:"arrayValue",content:o[c]};break;case"and":case"or":(d<1||2<d)&&paramsError(e.name);var i=evaluateNode({children:[e.children[0]]},r,t),l=evaluateNode({children:[e.children[1]]},r,t);n={type:"andor",content:"and"==e.name?i&&l:i||l};break;case"command":var d;1!=(d=e.children.length)&&paramsError(e.name),processCommand(evaluateNode({children:[e.children[0]]},r,t)),n={type:"command",content:""}}return n},getUserInput=function(e){return prompt(e)},processScript=function(e){var r=scriptTokenizer(e);try{return tokenParser(r)}catch(e){error(e.message),console.error(e)}},scriptTokenizer=function(e){var a=[],r=[{type:"STRING",ex:'"(.*?)"'},{type:"RETURN",ex:"return"},{type:"FUNCTION",ex:"function"},{type:"IF",ex:"if"},{type:"ELSE",ex:"else"},{type:"WHILE",ex:"while"},{type:"LBRACE",ex:"\\{"},{type:"RBRACE",ex:"\\}"},{type:"LPAREN",ex:"\\("},{type:"RPAREN",ex:"\\)"},{type:"TERNARY",ex:"\\?"},{type:"COLON",ex:"\\:"},{type:"COMMA",ex:"\\,"},{type:"EQUALEQUAL",ex:"\\=="},{type:"EQUAL",ex:"\\="},{type:"GREATER",ex:"\\>"},{type:"LESSER",ex:"\\<"},{type:"NOT",ex:"\\!="},{type:"PLUS",ex:"\\+"},{type:"MINUS",ex:"\\-"},{type:"MULTIPLY",ex:"\\*"},{type:"DIVIDE",ex:"\\/"},{type:"MODULO",ex:"\\%"},{type:"EMPTY",ex:"/s"},{type:"NAME",ex:"[a-zA-Z_][a-zA-Z0-9_]*"},{type:"NUMBER",ex:"[+-]?([0-9]*[.])?[0-9]+"}],t="(";r.forEach(function(e){t+=e.ex+"|"}),t=t.slice(0,t.length-1),t+=")",t=new RegExp(t,"g");var n=e.match(t);a=[];return n.forEach(function(t){var n=!1;r.forEach(function(e){if(!n){var r=new RegExp(e.ex);t.match(r)&&("STRING"==e.type&&(t=t.substring(1,t.length-1)),a.push({type:e.type,value:t}),n=!0)}})}),a},tokenIterator,tokenParser=function(e){for(var r,t,n=[],a=null,o=0,c=nextToken(tokenIterator={tokens:e,currentToken:0});c;){if(a){switch(t=tokenIterator.currentToken,c.type){case"LBRACE":o++;break;case"RBRACE":o--}if(0==o){if(r===t)throw new SyntaxError("Function has no content");a.tokens=e.slice(r+1,t-1),n.push(a),a=null}}else{assertType(tokenIterator.tokens[tokenIterator.currentToken-1],["FUNCTION"]),a={name:assertType(nextToken(),["NAME"]).value,parameters:[],tokens:[],children:[]},assertType(nextToken(),["LPAREN"]);for(var i=assertType(nextToken(),["NAME","RPAREN"]),l="NAME"===i.type;l;)a.parameters.push(i.value),(l="COMMA"===(i=assertType(nextToken(),["RPAREN","COMMA"])).type)&&(i=assertType(nextToken(),["NAME"]));o=0,r=tokenIterator.currentToken}c=nextToken()}if(0<o)throw new SyntaxError("Reached end of file while searching for end of function");return n.forEach(function(e){for(tokenIterator={tokens:e.tokens,currentToken:0},c=nextToken();c;){var r=parseStatement(c,e);"ELSE"!=r.blockType&&e.children.push(r),c=nextToken()}delete e.tokens}),n},arthemetic=["PLUS","MINUS","MULTIPLY","DIVIDE","MODULO"],comparator=["EQUALEQUAL","LESSER","GREATER","NOT"],parseStatement=function(e,r){var t={name:"",type:"",children:[]};switch(e.type){case"NAME":t.name=e.value;var n=tokenIterator.tokens[tokenIterator.currentToken].type;"LPAREN"===n?(t.type="FUNCTION_CALL",assertType(currentToken(),["LPAREN"]),nextToken(),constructStatement(t)):"EQUAL"===n?(t.type="VARIABLE_ASSIGNMENT",nextToken(),assertType(currentToken(),["LPAREN"]),nextToken(),constructStatement(t)):t.type="VARIABLE_IDENTIFIER";break;case"RETURN":t.type=e.type,constructStatement(t),delete t.name;break;case"IF":case"WHILE":t.type="BLOCK",t.blockType=e.type,t.statement={name:"",type:"",children:[]},parseExpression(t.statement),constructCodeBlock(t),delete t.name;break;case"ELSE":t.type="BLOCK",t.blockType="ELSE";var a=r.children[r.children.length-1];if("BLOCK"!=a.type||"IF"!=a.blockType)throw new Error("Else Statements can only be after if statements");constructCodeBlock(t),delete(a.else=t).name;break;default:t.name=e.value,t.type=e.type}return t},parseExpression=function(e){assertType(nextToken(),["LPAREN"]);for(var r=nextToken();r&&"RPAREN"!=r.type;)e.children.push(parseStatement(r,e)),r=nextToken();applyGrouping(e)},constructCodeBlock=function(e){assertType(nextToken(),["LBRACE"]);for(var r=nextToken();r&&"RBRACE"!=r.type;)e.children.push(parseStatement(r,e)),r=nextToken()},constructStatement=function(e){for(var r=1,t=nextToken();t&&0<r;){if("LPAREN"==t.type){var n={type:"EXPRESSION",children:[]};constructStatement(n),e.children.push(n)}else"RPAREN"==t.type?r--:"COMMA"!=t.type&&e.children.push(parseStatement(t,e));t=nextToken()}lastToken(),applyGrouping(e)},applyGrouping=function(e){var r=[],t=0;e.children.forEach(function(e){if(arthemetic.includes(e.type)&&1<++t)throw new SyntaxError("Only one arthemetic operation is allowed per expression")});for(var n=0;n<e.children.length;n++){var a=arthemetic.includes(e.children[n].type),o=comparator.includes(e.children[n].type);if(a||o){var c=r[n-1],i=e.children[n+1];if(!c||!i)throw new SyntaxError("Arthemetic/Comparator operations require two operands");var l=copy(c);delete c.name,c.type=a?"ARITHMETIC":"COMPARATOR",c.operator=e.children[n].type,c.children=[l,i],n++}else r.push(copy(e.children[n]))}e.children=r},currentToken=function(){return tokenIterator.tokens[tokenIterator.currentToken]},nextToken=function(){return tokenIterator.tokens[tokenIterator.currentToken++]},lastToken=function(){return tokenIterator.tokens[tokenIterator.currentToken--]},assertType=function(r,e){var t=!1;if(e.forEach(function(e){e===r.type&&(t=!0)}),t)return r;var n=tokenIterator.currentToken-1,a="",o=0;throw tokenIterator.tokens.forEach(function(e){Math.abs(o-n)<3&&(a+=o==n?"'"+e.value+"' ":e.value+" ",o++)}),new SyntaxError("Unexpected character '"+r.value+"' in "+a+". Expected one of these types: "+e)};function processCommand(e){if(0<e.length){var r=e.split(" ");switch(r[0]){case"echo":echo(e.split(/ (.+)/)[1]);break;case"mkdir":for(var t=1;t<r.length;t++)mkdirOrTouch(r[t],!0);break;case"cd":cd(r[1]);break;case"ls":ls(r[1]);break;case"pwd":echo(pwd()||"/");break;case"rm":for(t=1;t<r.length;t++)rm(r[t]);break;case"clear":vm.lines=linesRef=[];break;case"mv":case"cp":r[1]&&r[2]?mvOrcp(r[1],r[2],"cp"==r[0]):echo("Usage: mv source destination");break;case"touch":for(t=1;t<r.length;t++)mkdirOrTouch(r[t],!1);break;case"compile":r[1]&&r[2]?compile(r[1],r[2]):echo("Usage: compile source destination");break;case"execute":if(r[1]){var n=parseProgramJson(r[1]);if(n)try{execute(n)}catch(e){echo(e.message,errorColor),console.error(e)}}else echo("Usage: execute source");break;case"cat":for(t=1;t<r.length;t++)echo(dirAtPath(r[t],"dir").content);break;default:extraCommands(r||e)}}}errorColor="red",successColor="green";